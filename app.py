import streamlit as st
from transformers import AutoTokenizer, AutoModelForSequenceClassification
import requests
import torch



#classification
MODEL_NAME = "imaneumabderahmane/FA-Arabertv2-classifier-2"
tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
model = AutoModelForSequenceClassification.from_pretrained(MODEL_NAME)
LABELS = ["LABEL_0", "LABEL_1"]



def classify_question(text):
    inputs = tokenizer(text, return_tensors="pt", truncation=True, padding=True)
    outputs = model(**inputs)
    pred = torch.argmax(outputs.logits, dim=1).item()
    return LABELS[pred]

#chatbot response
api_key = st.secrets["OPENROUTER_API_KEY"]
def get_mistral_response(prompt, api_key):
    url = "https://openrouter.ai/api/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "mistralai/mistral-7b-instruct",
        "messages": [
        
  {
    "role": "system",
    "content": ".ุฃูุช ูุณุงุนุฏ ุทุจู ูุญุชุฑู ูุชุฎุตุต ูู ุงูุฅุณุนุงูุงุช ุงูุฃูููุฉ. ุฃุฌุจ ุฏุงุฆููุง ุจูุตุงุฆุญ ุฅุณุนุงู ุฃูููุฉ ูุงุถุญุฉ ูุฏูููุฉ ูุขููุฉ. ุงูุฑุฃ ุงูุณุคุงู ุงูุชุงูู ุจุนูุงูุฉ ููุฏู ุงูุฅุฌุงุจุฉ ุงูููุงุณุจุฉ"
  },

  {
    "role": "user",
    "content": "ุฃุตุงุจุชูู ุถุฑุจุฉ ุนูู ุนุธูุฉ ุญุงุฌุจู ุงูุฃูุณุฑ ูุญุฏูุซ ุงูุชูุงุฎ ุจุณูุท. ูุถุนุช ููุงุฏุงุช ุจุงุฑุฏุฉ. ูุงุฐุง ููุจุบู ุฃู ุฃูุนู ุฃูุถูุงุ"
  },
  {
    "role": "assistant",
    "content": "ุงุณุชูุฑ ุจูุถุน ููุงุฏุงุช ุจุงุฑุฏุฉ ููุชุฑุงุช ูุตูุฑุฉ (10โ15 ุฏูููุฉ ูู ุณุงุนุฉ) ูุชุฎููู ุงููุฑู. ุงุฑูุน ุฑุฃุณู ุนูุฏ ุงูุงุณุชููุงุก ูุชูููู ุงูุชูุฑูุ ูุชุฌููุจ ุงูุถุบุท ุนูู ุงูููุทูุฉ. ุฑุงูุจ ุฃู ุชุบููุฑ ูู ุงูุฑุคูุฉุ ููุฏุงู ูููุนูุ ุฃู ุชููุค โ ุฅุฐุง ุธูุฑุช ุฃู ูู ูุฐู ุงูุฃุนุฑุงุถ ูุฑุงุฌุน ุงูุทูุงุฑุฆ ููุฑูุง."
  },

  {
    "role": "user",
    "content": "ุญุฏุซ ูุฒูู ุฏุงุฎู ุงููุฎ ุซู ุชูุง ุฐูู ุถุนู ูู ุงูุณุงู ุงููุณุฑู ูุฎุฑู ููููุณุฉ. ูู ูุฐุง ุฒูุงููุฑ ุฃู ุดูุก ุขุฎุฑุ"
  },
  {
    "role": "assistant",
    "content": "ูุฐู ุฃุนุฑุงุถ ุฎุทูุฑุฉ ุชุชุทูุจ ุชูููููุง ุนุตุจููุง ุนุงุฌููุง. ุญุงูุงุช ุงููุฒูู ูุงูุฌูุทุฉ ุจุงููุฎ ูุฏ ุชุณุจุจ ุถุนููุง ููุถุนููุง ูุงุถุทุฑุงุจูุง ุฅุฏุฑุงูููุงุ ูุฐูู ููุฒู ุชุตููุฑ ููุทุนู ุฃู ุฑููู ูุบูุงุทูุณู ูุชูููู ูู ุฃุฎุตุงุฆู ุฃุนุตุงุจ ูุชุญุฏูุฏ ุงูุณุจุจ ูุฎุทุฉ ุงูุนูุงุฌ. ุชูุงุตู ูุน ููุฏู ุงูุฑุนุงูุฉ ุงูุทุงุฑุฆุฉ ุฃู ูุณู ุงูุฃุนุตุงุจ ููุฑูุง."
  },

  {
    "role": "user",
    "content": "ููู ุฃุชุนุงูู ูุน ุดุฎุต ูุชุนุฑุถ ูููุจุฉ ุตุฑุนุ"
  },
  {
    "role": "assistant",
    "content": "ุฃุจุนุฏ ุญููู ุงูุฃุดูุงุก ุงูุญุงุฏุฉ ูุญุงูุธ ุนูู ุงููุฏูุก. ุถุน ุดูุฆูุง ูุงุนููุง ุชุญุช ุฑุฃุณูุ ูุง ุชูููุฏ ุญุฑูุงุชูุ ููุง ุชุถุน ุดูุฆูุง ูู ููู. ุจุนุฏ ุงูุชูุงุก ุงูููุจุฉุ ุถุน ุงูุดุฎุต ุนูู ุฌูุจู ููุญูุงุธ ุนูู ูุฌุฑู ุงูููุงุก ูุฑุงูุจู ุญุชู ูุณุชุนูุฏ ูุนูู. ุฅุฐุง ุงุณุชูุฑุช ุงูููุจุฉ ุฃูุซุฑ ูู 5 ุฏูุงุฆู ุฃู ุชูุฑุฑุชุ ุงุทูุจ ุงูุฅุณุนุงู ููุฑูุง."
  },

  {
    "role": "user",
    "content": "ุงูุณูุงู ุนููููุ ููู ุฃุนุฑู ูุง ุฅุฐุง ูุงู ุฌุฑุญ ุงูุฑุฃุณ ูุญุชุงุฌ ุฎูุงุทุฉุ ุนููุงู ุฃูู ูุง ููุฌุฏ ูุฒูู ุงูุขูุ"
  },
  {
    "role": "assistant",
    "content": "ุฅู ูุงูุช ุงูุญุงูุฉ ูุงุณุนุฉ ุฃู ููุชูุญุฉ ุจุนูู ุฃู ูุงู ุงูุญุฌู ุฃูุจุฑ ูู 1 ุณู ุฃู ูุงู ุงูุฌุฑุญ ูู ูุฌูู ูุคุซุฑ ุนูู ุงูุดููุ ููุฏ ูุญุชุงุฌ ููุฎูุงุทุฉ ููููุถู ุนุฑุถ ุงููุตุงุจ ุนูู ุงูุทุจูุจ. ูุธู ุงูุฌุฑุญ ุจูุญููู ููุฒููููุฌูุ ุบุทูู ุจุดุงุด ูุนููุ ูุชุฌูุจ ุฅุนุงุฏุฉ ุงูุฎูุงุทุฉ ุจุนุฏ ูุฑูุฑ ุฃูุซุฑ ูู 12 ุณุงุนุฉ ุฏูู ุงุณุชุดุงุฑุฉ ุทุจูุฉ. ุฅุฐุง ุธูุฑุช ุนูุงูุงุช ุงูุชูุงุจ ุฃู ุนุฏู ุงูุชุฆุงูุ ุฑุงุฌุน ุงูุทุจูุจ."
  },

  {"role": "user", "content": prompt}
        ],
        "temperature": 0.7,
        "max_tokens": 256    }

    response = requests.post(url, headers=headers, json=data)
    if response.status_code == 200:
        return response.json()["choices"][0]["message"]["content"]
    else:
        return f"โ๏ธ Error from API: {response.text}"
    

# Streamlit UI
st.title("ุงููุณุงุนุฏ ุงูุฎุงุต ุจุงูุฅุณุนุงูุงุช ุงูุฃูููุฉ")

api_key = st.text_input(" :ูู ูุถูู ุฃุฏุฎู ุงูููุชุงุญ ุงูุฎุงุต ุจู ", type="password")

user_input = st.text_area(":ุงูุชุจ ุณุคุงูู ุจุงููุบุฉ ุงูุนุฑุจูุฉ", height = 100 )

if st.button("ุงุณุฃู"):
    if not api_key:
        st.warning("ูู ูุถูู ุฃุฏุฎู ุงูููุชุงุญ ุงูุฎุงุต ุจู")
    elif not user_input.strip():
        st.warning("ูู ูุถูู ุงูุชุจ ุณุคุงูู ")
    else:
        with st.spinner("...ุฌุงุฑ ุชุญููู ุณุคุงูู"):
            category = classify_question(user_input)

            if category == "LABEL_1":
                st.success("..ุชู ุงูุชุนุฑู ุนูู ุณุคุงู ุฅุณุนุงูุงุช ุฃูููุฉ. ูุญุตู ุงูุขู ุนูู ุงูุฅุฑุดุงุฏุงุช โ")
                with st.spinner("ุฌุงุฑู ุงูุชูุงุตู ูุน ุงููุณุงุนุฏ ุงูุฐูู..."):
                  answer = get_mistral_response(user_input, api_key)
                  st.write("### ๐ฌ ุงูุฌูุงุจ:")
                  st.write(answer)
            else:
                st.error(" ุนุฐุฑูุงุ ูููููู ุงูุฅุฌุงุจุฉ ููุท ุนูู ุงูุฃุณุฆูุฉ ุงููุชุนููุฉ ุจุงูุฅุณุนุงูุงุช ุงูุฃูููุฉโ")
